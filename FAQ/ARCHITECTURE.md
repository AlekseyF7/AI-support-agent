# Архитектура RAG Telegram Support Bot

## Обзор системы

Система представляет собой интеллектуального чат-бота для поддержки клиентов, который:
1. Отвечает на типовые вопросы через RAG (Retrieval-Augmented Generation)
2. Классифицирует обращения по тематике и критичности
3. Автоматически создает обращения на соответствующие линии поддержки

## Компоненты системы

### 1. RAG System (`bot/rag_system.py`)

**Назначение:** Поиск ответов в базе знаний с использованием векторного поиска

**Технологии:**
- LangChain для работы с LLM
- ChromaDB для векторной БД
- OpenAI Embeddings для создания векторных представлений
- OpenAI GPT для генерации ответов

**Процесс работы:**
1. Загрузка документов из `knowledge_base/`
2. Разбиение на чанки (chunks)
3. Создание векторных представлений
4. Сохранение в ChromaDB
5. При запросе: поиск похожих чанков → генерация ответа с контекстом

**Методы:**
- `load_knowledge_base()` - загрузка и индексация базы знаний
- `get_answer(question)` - получение ответа на вопрос
- `is_faq_question(question, answer)` - определение FAQ вопроса

### 2. Classifier (`bot/classifier.py`)

**Назначение:** Классификация обращений по тематике и критичности

**Тематики:**
- Доступ к системе
- Техническая проблема
- Программное обеспечение
- Оборудование
- Безопасность
- Конфигурация
- Системная проблема
- FAQ вопросы (различные категории)

**Приоритеты:**
- P1 (Критическая): Полная недоступность, утечка данных
- P2 (Высокая): Недоступность для группы, снижение производительности
- P3 (Средняя): Проблемы с функциями, незначительные сбои
- P4 (Низкая): Мелкие ошибки, вопросы по функциональности

**Методы:**
- `classify(description, conversation_history)` - классификация обращения

### 3. Escalation System (`bot/escalation.py`)

**Назначение:** Создание обращений и определение линии поддержки

**Линии поддержки:**
- 1-я линия: FAQ, простые вопросы, базовые проблемы
- 2-я линия: Сложные технические проблемы, настройка
- 3-я линия: Критические проблемы, системные сбои

**Правила эскалации:**
- P1 → 3-я линия
- P2 → 2-я линия (или 3-я если не решена)
- P3/P4 → 1-я линия
- Определенные тематики автоматически эскалируются

**Методы:**
- `determine_support_line(theme, priority, is_faq)` - определение линии
- `create_ticket(...)` - создание обращения
- `format_ticket_message(ticket)` - форматирование сообщения

### 4. Telegram Bot (`bot/telegram_bot.py`)

**Назначение:** Интеграция всех компонентов в Telegram бота

**Команды:**
- `/start` - приветствие и инициализация
- `/help` - справка по использованию
- `/clear` - очистка истории диалога

**Процесс обработки сообщения:**
1. Получение сообщения от пользователя
2. Поиск ответа в RAG системе
3. Классификация обращения
4. Определение необходимости эскалации
5. Создание обращения (если нужно)
6. Отправка ответа пользователю

**Особенности:**
- Сохранение истории диалога для контекста
- Индикатор печати при обработке
- Обработка ошибок

## База знаний

### Структура

```
knowledge_base/
├── faq/              # Часто задаваемые вопросы
│   ├── general_faq.md
│   ├── software_faq.md
│   └── security_faq.md
├── articles/         # Статьи и документация
│   ├── incident_management.md
│   └── escalation_rules.md
└── tickets/          # Примеры обращений
    ├── line1_tickets.md
    ├── line2_tickets.md
    └── line3_tickets.md
```

### Формат документов

Документы в формате Markdown с структурированной информацией:
- FAQ: Вопрос/Ответ пары
- Статьи: Описательные тексты с разделами
- Тикеты: Примеры обращений с метаданными

## Поток данных

```
Пользователь → Telegram Bot
                ↓
         RAG System (поиск ответа)
                ↓
         Classifier (классификация)
                ↓
         Escalation System (создание обращения)
                ↓
         Ответ пользователю
```

## Хранение данных

### Векторная БД (ChromaDB)
- Расположение: `./chroma_db/`
- Содержимое: Векторные представления документов базы знаний
- Автоматическое обновление при перезапуске

### Обращения (JSON)
- Расположение: `data/tickets.json`
- Формат: JSON массив с метаданными обращений
- Содержит: ID, описание, тематику, приоритет, линию, статус

## Расширяемость

### Добавление новых документов
1. Добавить `.md` файлы в `knowledge_base/`
2. Перезапустить бота
3. Автоматическая индексация

### Добавление новых тематик
1. Обновить `TicketClassifier.THEMES`
2. Обновить правила эскалации в `EscalationSystem`
3. Добавить примеры в базу знаний

### Настройка моделей
- Изменить модель OpenAI в `RAGSystem` и `TicketClassifier`
- Настроить параметры температуры и других гиперпараметров

## Безопасность

- API ключи хранятся в `.env` (не в репозитории)
- История диалогов хранится в памяти (не персистентно)
- Обращения содержат только необходимую информацию

## Производительность

- Векторная БД позволяет быстро искать похожие документы
- Кэширование истории диалога для контекста
- Асинхронная обработка сообщений через python-telegram-bot

## Мониторинг

- Логи в консоли при запуске
- Сохранение всех обращений в JSON
- Возможность анализа через просмотр `data/tickets.json`

