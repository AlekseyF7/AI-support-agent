"""
Фильтр вопросов для проверки релевантности
"""
import re
from typing import Tuple


class QuestionFilter:
    """Фильтр для проверки, относится ли вопрос к технической поддержке"""
    
    # Ключевые слова, указывающие на вопросы технической поддержки
    RELEVANT_KEYWORDS = [
        # Технические проблемы
        "не работает", "ошибка", "проблема", "не могу", "не получается",
        "не открывается", "не запускается", "не загружается", "не входит",
        "зависает", "тормозит", "медленно", "глючит", "сбой", "неисправность",
        
        # Доступ
        "пароль", "логин", "вход", "доступ", "авторизация", "авторизоваться",
        "забыл пароль", "сменить пароль", "восстановить", "учетная запись",
        
        # Программы и системы
        "программа", "приложение", "софт", "система", "портал", "сайт",
        "браузер", "почта", "почтовый", "клиент", "windows", "linux",
        "office", "word", "excel", "outlook",
        
        # Оборудование
        "принтер", "сканер", "монитор", "клавиатура", "мышь", "компьютер",
        "ноутбук", "устройство", "жесткий диск", "ssd", "процессор",
        
        # Сеть
        "интернет", "сеть", "подключение", "wi-fi", "wifi", "сетевой",
        "ip-адрес", "ip адрес", "dns", "роутер", "маршрутизатор",
        
        # Безопасность
        "антивирус", "вирус", "безопасность", "защита", "блокировка",
        "разблокировать", "заблокирован", "firewall", "брандмауэр",
        
        # Настройки
        "настроить", "настройка", "конфигурация", "параметры", "установить",
        "установка", "удалить", "удаление", "обновить", "обновление",
        
        # IT термины
        "сервер", "база данных", "backup", "резервная копия", "vpn",
        "домен", "аккаунт", "пользователь", "права доступа",
    ]
    
    # Ключевые слова, указывающие на НЕрелевантные вопросы
    IRRELEVANT_KEYWORDS = [
        # Общие вопросы
        "как дела", "как жизнь", "что нового", "расскажи о себе",
        "кто ты", "что ты умеешь", "что ты можешь",
        
        # Погода и время
        "погода", "время", "какой час", "сколько времени",
        
        # Развлечения
        "анекдот", "шутка", "расскажи историю", "поиграй",
        "музыка", "фильм", "игра",
        
        # Личные вопросы
        "как тебя зовут", "сколько тебе лет", "откуда ты",
        
        # Общие знания
        "столица", "президент", "история", "география",
        
        # Покупки и магазины (НЕ техподдержка)
        "магазин", "купить", "покупка", "продажа", "цена", "стоимость",
        "фрукты", "овощи", "еда", "продукты", "ресторан", "кафе",
        "одежда", "обувь", "товар", "заказать",
        
        # Путешествия
        "путешествие", "отпуск", "отель", "билет", "самолет",
        
        # Здоровье
        "врач", "лечение", "болезнь", "лекарство", "больница",
        
        # Образование (не IT)
        "школа", "университет", "учеба", "экзамен",
    ]
    
    # Паттерны нерелевантных вопросов
    IRRELEVANT_PATTERNS = [
        r"^привет\s*$",
        r"^здравствуй\s*$",
        r"^как дела\??\s*$",
        r"^что ты\??\s*$",
        r"^кто ты\??\s*$",
    ]
    
    @classmethod
    def is_relevant(cls, question: str) -> Tuple[bool, str]:
        """
        Проверяет, относится ли вопрос к технической поддержке
        
        Args:
            question: Вопрос пользователя
            
        Returns:
            Tuple[bool, str]: (релевантен ли вопрос, причина)
        """
        question_lower = question.lower().strip()
        
        # Проверка на явно нерелевантные вопросы
        for pattern in cls.IRRELEVANT_PATTERNS:
            if re.match(pattern, question_lower):
                return False, "Общий вопрос, не связанный с технической поддержкой"
        
        # Проверка на нерелевантные ключевые слова
        for keyword in cls.IRRELEVANT_KEYWORDS:
            if keyword in question_lower:
                return False, f"Вопрос содержит нерелевантное ключевое слово: {keyword}"
        
        # СТРОГАЯ проверка: вопрос должен содержать релевантные ключевые слова
        relevant_count = sum(1 for keyword in cls.RELEVANT_KEYWORDS if keyword in question_lower)
        
        # Если нет релевантных ключевых слов - вопрос нерелевантен
        if relevant_count == 0:
            return False, "Вопрос не содержит ключевых слов технической поддержки"
        
        # Если есть релевантные слова - проверяем, что нет явно нерелевантных
        irrelevant_count = sum(1 for keyword in cls.IRRELEVANT_KEYWORDS if keyword in question_lower)
        
        # Если есть нерелевантные слова - вопрос отклоняем
        if irrelevant_count > 0:
            return False, f"Вопрос содержит нерелевантные ключевые слова (найдено {irrelevant_count})"
        
        # Если есть релевантные слова и нет нерелевантных - вопрос релевантен
        return True, f"Вопрос содержит {relevant_count} релевантных ключевых слов"
    
    @classmethod
    def get_rejection_message(cls) -> str:
        """Возвращает сообщение об отклонении нерелевантного вопроса"""
        return (
            "Я могу помочь только с вопросами технической поддержки.\n\n"
            "Пожалуйста, задайте вопрос о:\n"
            "• Работе систем и программного обеспечения\n"
            "• Проблемах с доступом или авторизацией\n"
            "• Настройке оборудования\n"
            "• IT-проблемах и ошибках\n"
            "• Других вопросах технической поддержки"
        )

