services:
  # Телеграм-бот
  bot:
    build:
      context: .
      args:
        - EMBEDDING_MODEL_NAME=${EMBEDDING_MODEL_NAME:-intfloat/multilingual-e5-small}
    container_name: sber_support_bot
    restart: always
    env_file:
      - .env
    volumes:
      - ./support.db:/app/support.db
      - ./chroma_db:/app/chroma_db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - api

  # API сервер для Mini App (O2O)
  api:
    build:
      context: .
      args:
        - EMBEDDING_MODEL_NAME=${EMBEDDING_MODEL_NAME:-intfloat/multilingual-e5-small}
    container_name: sber_support_api
    restart: always
    command: python app_server.py
    ports:
      - "8000:8000"
    env_file:
      - .env
    volumes:
      - ./support.db:/app/support.db
      - ./chroma_db:/app/chroma_db
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Ngrok туннель для доступа к Mini App
  ngrok:
    image: ngrok/ngrok:latest
    container_name: sber_support_ngrok
    restart: always
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN}
    command:
      - "http"
      - "api:8000"
      - "--domain=siphonlike-ardelia-unrecuperative.ngrok-free.dev"
    depends_on:
      - api

volumes:
  # Рекомендуется использовать именованные тома для продакшена, 
  # но для удобства разработки используем bind mounts выше.
  db_data:
  vector_data:
